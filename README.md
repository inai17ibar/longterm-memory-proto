# 長期記憶機能付きAIメンタルヘルスカウンセラー

## 概要
このプロジェクトは、うつ病で休職中の方や復職を目指している方をサポートするAIメンタルヘルスカウンセラーを提供します。AIは会話の文脈を理解し、ユーザーの過去の発言や状況を記憶しながら、継続的なサポートを提供します。

## 主な機能

### 🧠 高度な記憶システム
- **カテゴリ別長期記憶**: メンタルヘルス特化の情報分類と保存
  - 悩み・心配事、目標・願望、症状・体調、ストレス要因
  - 対処法、サポート体制、医療情報、勤務・復職状況
  - 日常・生活パターン、感情状態など
- **記憶品質フィルタリング**: 重複検出、類似度判定、重要度スコアリング
- **エピソード記憶**: 時系列イベントの自動抽出と重要度評価
- **記憶統合**: 類似記憶の自動マージとサマリー生成
- **記憶関連性分析**: カテゴリ、時間、因果関係に基づく記憶ネットワーク

### 👤 ユーザープロファイルシステム
- **包括的なプロファイル管理**: 18種類の属性を自動抽出・更新
  - 基本情報: 名前、職業、趣味、年齢、居住地、家族構成
  - メンタルヘルス: 悩み、目標、症状、トリガー、対処法
  - サポート: 支援体制、服薬・通院、勤務状況、日常生活、感情状態
- **会話からの自動抽出**: LLMによる自然な会話からのプロファイル更新
- **SQLite永続化**: データベースによる安全なデータ保存

### 📊 感情・状態分析
- **リアルタイム状態推定**: 気分・エネルギー・不安レベル（0-10スケール）
- **感情履歴トラッキング**: 時系列での感情変化の記録と傾向分析
- **文脈パターン分析**: 時刻別・曜日別のパターン検出
- **応答アプローチ提案**: ユーザー状態に応じた最適な対話トーン

### 💬 その他の機能
- **柔軟なデータ管理**: チャット履歴クリア（記憶保持）と完全削除の選択
- **個別化されたカウンセリング**: 蓄積された記憶・プロファイル・感情履歴に基づく継続的サポート
- **会話履歴の保存とCSVエクスポート**: セッション記録の管理
- **RESTful APIによる通信**: フロントエンド・バックエンド間の効率的な連携

## 技術スタック
### バックエンド
- FastAPI (Python)
- OpenAI GPT-4o / GPT-4o-mini (フォールバック対応)
- SQLite データベース（ユーザープロファイル、エピソード記憶、感情履歴）
- In-memory データストレージ（会話履歴、短期記憶）
- LLMベース情報抽出（プロファイル、エピソード、記憶統合）

### フロントエンド
- React (TypeScript)
- インラインCSS（Tailwind CSS代替）
- レスポンシブデザイン

## セットアップ手順

### 環境変数の設定
1. `backend` ディレクトリに `.env` ファイルを作成
2. 以下の環境変数を設定（OpenAI APIキーは任意）:
```
OPENAI_API_KEY=your_api_key_here
```
**注意**: APIキーが設定されていない場合、キーワードベースの記憶抽出が動作します。

### バックエンドのセットアップ
```bash
cd backend
# 仮想環境の作成と有効化
python -m venv venv
venv\Scripts\activate  # Windows
# venv/Scripts/activate #bash
# source venv/bin/activate  # macOS/Linux

# 依存関係のインストール
pip install --upgrade pip
pip install -r requirements.txt

# サーバー起動
uvicorn app.main:app --reload
```

### フロントエンドのセットアップ
```bash
cd frontend
# 依存関係のインストール
npm install

# 開発サーバー起動（ポート3001）
npm start
```

アプリケーションは以下でアクセス可能：
- フロントエンド: http://localhost:3001
- バックエンドAPI: http://localhost:8000

## API エンドポイント

### ユーザー関連
- `POST /api/users` - ユーザー情報の作成/更新
- `GET /api/users/{user_id}` - ユーザー情報の取得（記憶カテゴリ含む）
- `DELETE /api/users/{user_id}` - ユーザーデータの完全削除

### ユーザープロファイル
- `GET /api/profile/{user_id}` - ユーザープロファイルの取得
- `GET /api/state/{user_id}` - 現在の状態分析の取得

### チャット関連
- `POST /api/chat` - AIカウンセラーとのチャット（記憶・プロファイル・感情記録付き）
- `GET /api/conversations/{user_id}` - 会話履歴の取得
- `DELETE /api/conversations/{user_id}` - チャット履歴のみクリア（記憶保持）
- `GET /api/export-conversations/{user_id}` - 会話履歴のCSVエクスポート

### エピソード記憶・感情履歴
- `GET /api/episodes/{user_id}` - エピソード記憶の取得
- `GET /api/emotions/{user_id}` - 感情履歴の取得
- `GET /api/emotions/{user_id}/trends` - 感情トレンド分析の取得

### 記憶統合・関連性分析
- `GET /api/memories/{user_id}/summary` - 記憶サマリーの取得（期間指定可能）
- `POST /api/memories/{user_id}/consolidate` - 類似記憶の統合実行
- `GET /api/memories/{user_id}/graph` - 記憶関連性グラフの取得
- `GET /api/memories/{user_id}/{memory_id}/related` - 関連記憶の検索

### ヘルスチェック
- `GET /healthz` - サーバー稼働状況の確認

## システムアーキテクチャ

### 記憶システムの詳細

#### 1. カテゴリ別記憶機能
以下のカテゴリで情報を自動分類・保存：

- **💭 悩み・心配事** (`concerns`): 不安や心配事の記録
- **🎯 目標・願望** (`goals`): 目指していることや願望
- **🩺 症状・体調** (`symptoms`): 睡眠、食欲、気分の変化
- **⚠️ ストレス要因** (`triggers`): ストレスの原因や引き金
- **🛠️ 対処法** (`coping_methods`): 有効な対処法やリラックス方法
- **🤝 サポート体制** (`support_system`): 支援者や相談相手
- **💊 医療・服薬情報** (`medication`): 治療や薬物療法の状況
- **💼 勤務・復職状況** (`work_status`): 就労状況や復職の進捗
- **📅 日常・生活パターン** (`daily_routine`): 生活リズムや習慣
- **💭 感情状態** (`emotional_state`): 現在の気持ちや感情

#### 2. 記憶品質管理
- **最小文字数チェック**: 5文字未満の記憶を除外
- **重複検出**: 完全一致および90%以上の類似記憶を排除
- **重要度スコアリング**: 0.0-1.0の範囲で各記憶の重要度を評価（閾値: 0.15）
- **時間減衰**: エピソード記憶の重要度は時間経過とともに減衰（エビングハウスの忘却曲線）

#### 3. エピソード記憶システム
- **自動抽出**: 会話から重要なエピソードをLLMが自動検出
- **感情記録**: エピソードに紐づく感情タイプと強度（0.0-1.0）
- **コンテキスト保存**: 発生時刻、関連トピック、状況などを記録
- **データベース**: `episodic_memory.db`に永続化

#### 4. 記憶統合・関連性分析
- **類似記憶の統合**: Jaccard類似度に基づき類似記憶をマージ
- **記憶サマリー**: カテゴリ別・期間別の記憶要約を生成
- **関連性スコアリング**: 以下の要素で記憶間の関連性を評価
  - 同一カテゴリ: +0.3
  - 時間的近接性: +0.2-0.3
  - 内容類似度: 最大+0.5
  - 因果関係: +0.4
- **記憶グラフ**: ノード（記憶）とエッジ（関連性）のネットワーク構造

### ユーザープロファイルシステム

#### プロファイル属性（18種類）
会話から自動的に以下の情報を抽出・更新：

**基本情報**:
- 名前、職業、趣味、年齢、居住地、家族構成

**メンタルヘルス関連**:
- 悩み・不安、目標・願望、性格特徴、重要な体験
- 症状（睡眠、食欲、気分変化など）、トリガー、対処法

**サポート・医療**:
- サポート体制、服薬・通院状況、勤務・休職・復職状況
- 日常生活パターン、現在の感情状態

#### データ永続化
- SQLiteデータベース: `user_profiles.db`
- LLM自動抽出: GPT-4o-miniによる会話からの情報抽出

### 感情・状態分析システム

#### リアルタイム状態推定
- **気分レベル**: 0（非常に悪い）〜 10（非常に良い）
- **エネルギーレベル**: 0（極度の疲労）〜 10（非常に活発）
- **不安レベル**: 0（穏やか）〜 10（極度の不安）

#### 感情履歴トラッキング
- 各会話後に自動記録
- 7日間のトレンド分析
- データベース: `episodic_memory.db`

#### 文脈パターン分析
- 時刻別パターン（朝・昼・夕・夜）
- 曜日別パターン（平日・週末）
- 過去の類似状況からの学習

### データ管理オプション
- **チャット履歴クリア**: 会話のみ削除、記憶情報は保持
- **完全データ削除**: 会話履歴と記憶情報の全削除

## 注意事項
- このAIカウンセラーは医療行為や診断を行いません
- 緊急時や危機的状況では、必ず専門家に相談してください
- ユーザーデータの保存形式:
  - **SQLiteデータベース**: ユーザープロファイル、エピソード記憶、感情履歴（永続化）
  - **In-memory**: 会話履歴、短期記憶（サーバー再起動時にクリア）
- 記憶アイテムは最大100件まで保存され、古いものから自動削除されます
- データベースファイル: `user_profiles.db`, `episodic_memory.db`（`.gitignore`で管理）

## トラブルシューティング

### よくある問題と解決方法

**1. PowerShellでの実行ポリシーエラー**
```powershell
Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser
```

**2. 仮想環境の有効化について**
- Windows: `venv\Scripts\activate`
- macOS/Linux: `source venv/bin/activate`
- 終了時: `deactivate`

**3. OpenAI APIキーの設定**
- **必須**: プロファイル抽出、エピソード記憶、記憶統合にはOpenAI APIキーが必要です
- `backend/.env`に`OPENAI_API_KEY`を設定してください

**4. ポート番号の確認**
- フロントエンド: http://localhost:3001
- バックエンド: http://localhost:8001（ポート8001で起動）

**5. データベースファイルの管理**
- `user_profiles.db`と`episodic_memory.db`は自動作成されます
- `.gitignore`に含まれているため、Git管理外です

## 開発者向け情報

### デバッグ機能
- **ブラウザ開発者ツール**: コンソールログで記憶抽出過程を確認
- **ProfileDebug**: ユーザープロファイルと現在の状態分析を可視化
- **EmotionHistory**: 感情トレンドとエピソード記憶を表示
- **MemoryInsights**: 記憶サマリーと関連性ネットワークを可視化
- **バックエンドログ**: 記憶品質フィルタリングの詳細を出力

### 環境変数
```bash
# バックエンド/.env
OPENAI_API_KEY=your_api_key_here

# フロントエンド/.env
PORT=3001
REACT_APP_API_URL=http://localhost:8001
```

### 主要なファイル構成
```
backend/app/
├── main.py                    # メインAPIエンドポイント
├── memory_system.py           # カテゴリ別記憶+品質フィルタリング
├── user_profile.py            # ユーザープロファイル管理
├── analysis_layer.py          # 状態分析・推論エンジン
├── episodic_memory.py         # エピソード記憶+感情履歴
└── memory_consolidation.py    # 記憶統合+関連性分析

frontend/src/
├── App.tsx                    # メインアプリケーション
├── ProfileDebug.tsx           # プロファイルデバッグUI
├── EmotionHistory.tsx         # 感情履歴表示
└── MemoryInsights.tsx         # 記憶インサイト表示

データベース:
├── user_profiles.db           # ユーザープロファイル
└── episodic_memory.db         # エピソード記憶+感情履歴
```

## ライセンス
このプロジェクトはMITライセンスの下で公開されています。
